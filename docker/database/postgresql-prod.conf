# PostgreSQL 16 Configuration for AI Social Media Platform
# Production Environment Configuration
# This file is mounted into the container at /etc/postgresql/postgresql.conf

# =============================================================================
# CONNECTIONS AND AUTHENTICATION
# =============================================================================

# Connection settings for production
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# Authentication and security
ssl = on
ssl_cert_file = '/var/lib/postgresql/server.crt'
ssl_key_file = '/var/lib/postgresql/server.key'
ssl_ca_file = '/var/lib/postgresql/ca.crt'
ssl_crl_file = ''
ssl_prefer_server_ciphers = on
password_encryption = scram-sha-256

# =============================================================================
# MEMORY CONFIGURATION
# =============================================================================

# Memory settings optimized for production (assuming 8GB RAM)
shared_buffers = 2GB
effective_cache_size = 6GB
maintenance_work_mem = 512MB
work_mem = 16MB
wal_buffers = 32MB
huge_pages = try

# =============================================================================
# WRITE-AHEAD LOGGING (WAL)
# =============================================================================

# WAL settings for production with replication
wal_level = replica
max_wal_size = 4GB
min_wal_size = 1GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on
wal_buffers = 32MB

# Archive settings (enable if using continuous archiving)
# archive_mode = on
# archive_command = 'test ! -f /backup/archive/%f && cp %p /backup/archive/%f'

# =============================================================================
# REPLICATION (if using streaming replication)
# =============================================================================

# Replication settings
max_wal_senders = 3
wal_keep_size = 2GB
hot_standby = on
hot_standby_feedback = on

# =============================================================================
# QUERY TUNING
# =============================================================================

# Query optimization for production workload
random_page_cost = 1.1
effective_io_concurrency = 200
max_worker_processes = 16
max_parallel_workers_per_gather = 4
max_parallel_workers = 16
max_parallel_maintenance_workers = 4

# =============================================================================
# LOGGING
# =============================================================================

# Production logging configuration
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_truncate_on_rotation = off
log_rotation_age = 1d
log_rotation_size = 1GB

# What to log in production
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 5000
log_checkpoints = on
log_connections = off
log_disconnections = off
log_lock_waits = on
log_statement = 'ddl'
log_temp_files = 0
log_autovacuum_min_duration = 10000

# =============================================================================
# STATISTICS
# =============================================================================

# Statistics collection
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl
stats_temp_directory = 'pg_stat_tmp'

# =============================================================================
# AUTOVACUUM
# =============================================================================

# Autovacuum settings optimized for high-traffic social media platform
autovacuum = on
log_autovacuum_min_duration = 10000
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 100
autovacuum_analyze_threshold = 100
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Locale and formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# PRODUCTION TIMEOUTS AND LIMITS
# =============================================================================

# Statement timeout (2 minutes for production)
statement_timeout = 120000

# Lock timeout
lock_timeout = 30000

# Idle in transaction timeout (5 minutes)
idle_in_transaction_session_timeout = 300000

# TCP settings
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# =============================================================================
# EXTENSIONS AND FEATURES
# =============================================================================

# Shared preload libraries for production monitoring
shared_preload_libraries = 'pg_stat_statements,auto_explain,pg_buffercache'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# auto_explain for slow queries
auto_explain.log_min_duration = 10000
auto_explain.log_analyze = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_verbose = off

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# Security settings
ssl_min_protocol_version = 'TLSv1.2'
ssl_max_protocol_version = 'TLSv1.3'
ssl_ciphers = 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256'

# =============================================================================
# PERFORMANCE MONITORING
# =============================================================================

# Performance monitoring (disabled in production for performance)
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off
log_statement_stats = off

# =============================================================================
# CUSTOM SETTINGS FOR AI SOCIAL PLATFORM
# =============================================================================

# Application identification
application_name = 'ai-social-platform-prod'

# Full-text search configuration optimized for social media
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# BACKUP AND RECOVERY
# =============================================================================

# Point-in-time recovery settings
# Enable these if using continuous archiving
# restore_command = 'cp /backup/archive/%f %p'
# recovery_target_timeline = 'latest'

# =============================================================================
# MONITORING AND ALERTING
# =============================================================================

# Settings for external monitoring tools
# These can be queried by monitoring systems

# Log slow queries for monitoring
log_min_duration_statement = 5000

# Enable detailed wait event information
track_activities = on
track_io_timing = on

# =============================================================================
# NOTES FOR PRODUCTION DEPLOYMENT
# =============================================================================

# Additional production considerations:
# 1. Configure proper SSL certificates
# 2. Set up streaming replication for high availability
# 3. Configure continuous archiving for point-in-time recovery
# 4. Monitor key metrics: connections, locks, I/O, cache hit ratio
# 5. Set up alerts for long-running queries, high connection count
# 6. Regular vacuum and analyze scheduling
# 7. Connection pooling with pgbouncer
# 8. Regular backup testing and recovery procedures
# 9. Database parameter tuning based on actual workload
# 10. Security hardening and access control